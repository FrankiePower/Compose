name: CI

on:
  pull_request:

env:
  FOUNDRY_PROFILE: ci

jobs:
  check:
    name: Coverage
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Run coverage
        run: |
          forge coverage --report summary --report lcov
          ls -la lcov.info || echo "lcov.info not found"

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const file = 'lcov.info';
            let pct = '-';
            if (fs.existsSync(file)) {
              const content = fs.readFileSync(file, 'utf8');
              const match = content.match(/LF:\s*(\d+)\s*LH:\s*(\d+)/);
              if (match) {
                const total = Number(match[1]);
                const covered = Number(match[2]);
                pct = Math.round((covered / total)*100) + '%';
              }
              const body = `## ðŸ“Š Coverage Report\n\n**Coverage:** ${pct}\n\n<details><summary>lcov.info</summary>\n\`\`\`\n${fs.readFileSync(file,'utf8')}\n\`\`\`\n</details>`;
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            } else {
              console.log('Coverage file not found.');
            }
